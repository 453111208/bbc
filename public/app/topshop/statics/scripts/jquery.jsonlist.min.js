(function(e){e.fn.jsonList=function(a){return this.each(function(){e(this).data("JSONList",new n(this,a))})};var n=new Class({idPrefix:"checkbox_",_uniqueId:0,options:{url:null,data:null,items:"children",label:"name",name:"",response:function(a,b){},success:function(a){},listItem:function(a,b,d){},showSubList:function(a){},hideSubList:function(a){}},init:function(a,b){this.container=e(a);this.setOptions(b);b=this.options;var d=this;e.getJSON(b.url,b.data,function(a,b){d.data=a;d.trigger("response",
[d,b]);d.handleSuccess(a,b);d.trigger("success",[d,b])})},handleSuccess:function(a,b){"success"==b?(this.attachEvent(),this.container.addClass("tree-list")):alert("网络错误，请重试。");return this},build:function(a){if(a){var b=['<ol class="primary clearfix">'],d=this;e.each(a,function(){b.push(d.createItem(this))});b.push(this.createMarginItem());b.push("</ol>");this.container.html(b.join("\n"));var c=this.container.find(".has-children > label > input[type=checkbox]");e.each(a,function(){if(!this.disabled){var a=
this;c.each(function(){a.indeterminate&&this.value==a.id&&(this.indeterminate=!0)})}});this.marginItem=this.container.find(".margin-element");return this}},rebuild:function(a,b){this.container.empty();this.changeStatus(this.data,a,b);this.build(this.data);return this},createItem:function(a){if(a.disabled)return"";var b="col-md-2 item collapsed",d="",c="",e=this.options.items;a[e]&&(b+=" has-children",d=this.createThumb(),c=this.createChildren(a[e]));return['<li class="'+b+'">',"<label>",this.createCheckbox(a),
a[this.options.label],"</label>",d,c,"</li>"].join("\n")},createCheckbox:function(a){return'<input type="checkbox" name="'+this.options.name+'[]" value="'+a.id+'" '+(a.checked?"checked":"")+" "+(a.disabled?"disabled":"")+">"},createMarginItem:function(a){return'<li class="margin-element"></li>'},createThumb:function(){return'<i class="thumb"></i>'},createChildren:function(a){var b=this,d=['<ol class="sub clearfix">'];a&&a.length&&e.each(a,function(a){d.push(b.createSubItem(this))});d.push("</ol>");
return d.join("\n")},createSubItem:function(a){return a.disabled?"":['<li class="col-md-3">\n<label>',this.createCheckbox(a),a[this.options.label],"</label>\n</li>"].join("\n")},itemSelector:"li",attachEvent:function(){var a=this;this.container.on("click",".thumb",function(){a.toggle(e(this).parent(a.itemSelector))}).on("change",".has-children > label > input[type=checkbox]",function(b){b=this.checked;e(this).parents(a.itemSelector).eq(0).find(".sub input[type=checkbox]").prop("checked",b);a.setChecked(this,
b)}).on("change",".sub input[type=checkbox]",function(b){b=this.checked;var d=!1,c=e(this).parents(".sub"),f=c.siblings("label").find("input[type=checkbox]")[0];c.find("input[type=checkbox]").filter(b?":not(:checked)":":checked").length?(a.setIndeterminate(f),d=!0):(f.indeterminate=!1,f.checked=b);a.setChecked(this,b,d)});return this},setDisabledChecked:function(a,b){var d=this.options.items,c=a.value;e.each(this.data,function(){this.id==c&&(this.checked=b,this[d]&&this[d].length&&e.each(this[d],
function(a){this.disabled||(this.checked=b)}))});return this},setChecked:function(a,b,d){var c=this.options.items,f=a.value;e.each(this.data,function(){if(this.id==f)d||(delete this.indeterminate,this.checked=b),this[c]&&this[c].length&&e.each(this[c],function(){this.disabled||(this.checked=b)});else if(this[c]&&this[c].length){var a=0,g=0;e.each(this[c],function(){this.id==f&&(this.checked=b);this.disabled?g++:this.checked===b&&a++});!d&&a&&a===this[c].length-g&&(delete this.indeterminate,this.checked=
b)}});return this},setIndeterminate:function(a){a.indeterminate=!0;a.checked=!1;e.each(this.data,function(){this.id==a.value&&(this.indeterminate=!0,delete this.checked)});return this},changeStatus:function(a,b,d){var c=this.options.items,f=this;if(e.isArray(a))e.each(a,function(){f.changeStatus(this,b,d)});else{if(b)if(b.length)if(0<=b.indexOf(a.id))a.disabled=!0,a[c]&&e.each(a[c],function(){this.disabled=!0});else if(a[c]&&a[c].length){var h=0;e.each(a[c],function(){0<=b.indexOf(this.id)?(this.disabled=
!0,h++):delete this.disabled;h&&h===a[c].length?a.disabled=!0:delete a.disabled})}else delete a.disabled,a[c]&&a[c].length&&e.each(a[c],function(){delete this.disabled});else delete a.disabled,a[c]&&a[c].length&&e.each(a[c],function(){delete this.disabled});if(d)if(d.length)if(0<=d.indexOf(a.id))a.checked=!0,a[c]&&a[c].length&&e.each(a[c],function(){this.checked=!0});else if(a[c]&&a[c].length){var g=h=0;e.each(a[c],function(){0<=d.indexOf(this.id)?(this.checked=!0,h++):delete this.checked;this.disabled&&
g++});if(h){var l=a[c].length-g;h===l?(delete a.indeterminate,a.checked=!0):h<l&&(delete a.checked,a.indeterminate=!0)}else delete a.checked,delete a.indeterminate}else delete a.checked,delete a.indeterminate,a[c]&&a[c].length&&e.each(a[c],function(){delete this.checked});else delete a.checked,delete a.indeterminate,a[c]&&a[c].length&&e.each(a[c],function(){delete this.checked})}return this},toggle:function(a){return this[a.hasClass("expanded")?"collaspe":"expand"](a)},expand:function(a){var b=a.find(".sub");
a.addClass("expanded").removeClass("collapsed").siblings(".expanded").addClass("collapsed").removeClass("expanded");b.css("left",-a.position().left);this.getLineItem(a);this.marginItem.css("margin-bottom",b.height()+20);return this.trigger("showSubList",b)},collaspe:function(a){a.addClass("collapsed").removeClass("expanded");this.marginItem.css("margin-bottom","");return this.trigger("hideSubList",a.find(".sub"))},getLineItem:function(a){var b=a,d=a.nextAll();d.length?(d.each(function(c){return e(this).position().top!==
a.position().top?(b=e(this),!1):!0}),b.before(this.marginItem)):b.after(this.marginItem);return b},getChecked:function(a){function b(a,b,d){if("value"==d){var m=[b[d]],k=[];e.each(b[c],function(){this.checked&&k.push(this[d])});k.length&&m.push('<em class="text-muted">(',k.join(),")</em>");f[a].push(m.join(""))}else e.each(b[c],function(){this.checked&&f[a].push(this[d])})}var d=this,c=this.options.items,f=[];"string"===typeof a&&(a=[a]);e.each(a,function(a,g){f[a]=[];e.each(d.data,function(){if(this.checked){if(this[c]&&
this[c].length)for(var d=0,e=this[c].length,k;d<e;d++)if(k=this[c][d],k.disabled){b(a,this,g);return}f[a].push(this[g])}else this.indeterminate&&b(a,this,g)})});return f},isDisabled:function(){var a=0;e.each(this.data,function(){this.disabled&&a++});return a&&a===this.data.length}})})(jQuery);