var Widgets=new Class({options:{},init:function(a,b,c){this.dragSelecterString=a;this.dropSelecterString=b;this.drags=$(a);this.drops=$(b);this.setOptions(c);if(this.drag_operate_box=$("#drag_operate_box"))this.drag_operate_box.data("lock",!1),this.drag_handle_box=this.drag_operate_box.find(".drag_handle_box"),this.dragSign=$("#drag_ghost_box").appendTo(document.body),this.trigger("init",this),this.initDOBBase(this.drops),this.initDrags(this.drags),this.initDrops(this.drops),this.drags.each(function(){$(this).attr("ishtml")&&
$(this).find(".content-html").html($(this).find(".content-textarea").val())})},checkEmptyDropPanel:function(a){if(a&&$(a).hasClass(this.dropSelecterString.substring(1,this.dropSelecterString.length)))if($(a).find(this.dragSelecterString).size())$(a).find(".empty_drop_box").remove();else if(!$(a).find(".empty_drop_box").size()){var b=$('<div class="empty_drop_box"></div>').html('&nbsp;<button type="button" class="btn btn-add-widgets"><span><span><i class="icon"></i>添加挂件</span></span></button>').appendTo(a);
b.on("click",function(a){this.trigger("add",[b],this)}.bind(this));this.dragmoveInstance&&($(a).data("droppanel",!0),this.dragmoveInstance.droppables.push(a))}},initDOBBase:function(a){var b=this.drag_operate_box,c=this.drag_handle_box,d=this;a&&(c.find(".btn-up-slot,.btn-down-slot").on("click",function(a){a.preventDefault();a.stopPropagation();if((a=b.data("drag"))&&a.size()){a.parent().children();var h,c;$(this).hasClass("btn-up-slot")?(h=a.prev(),c="after"):(h=a.next(),c="before");h.size()&&(a[c](h),
$(document.body).trigger("mouseover",{target:a}),d.trigger("upDown",[b.data("drag")],d))}}),c.find(".btn-edit-widgets").on("click",function(a){a.preventDefault();d.trigger("edit",[b.data("drag")],d)}),b.on("dblclick",function(a){a.preventDefault();d.trigger("edit",[b.data("drag")],d)}),c.on("dblclick",function(a){a.preventDefault()}),c.find(".btn-del-widgets").on("click",function(a){a.preventDefault();d.trigger("delete",[b.data("drag")],d)}),c.find("li").on("click",function(a){a.stopPropagation();
d.trigger("add",[b.data("drag"),$(a.target)],d)}))},initDrags:function(a){var b=this,c=this.drag_operate_box,d=this.drag_handle_box,e;$(document.body).on("mouseover",function(h){h=$(h.target);var g=h.parents(b.dragSelecterString);!g.size()&&!h.hasClass(b.dragSelecterString.substr(1))||c.data("lock")||(g=g.size()?g:h,b.trigger("initDrags",[g,a],b),d.attr("title",g.attr("title")||"&nbsp;"),c.css("visibility","visible"),c.data("drag",g),e={top:g.offset().top-d.height(),left:g.offset().left,height:g.height()-
c.patch().y+d.height(),width:g.width()-c.patch().x},h=235+c.patch().x,b.drag_handle_box.css({left:e.left+h+parseInt(c.css("border-left"))>$(document.body).width()?e.width-h:0}),b.drag_operate_box.css(e),d.find(".btn-up-slot,.btn-down-slot").removeClass("disabled"),g.prev().size()||d.find(".btn-up-slot").addClass("disabled"),g.next().size()||d.find(".btn-down-slot").addClass("disabled"))});$(function(){a.each(function(){b.checkEmptyDrag(this);$(this).find("form").off().on("submit",function(a){a.preventDefault();
a.stopPropagation()});$(this).find("a").off().on("click",function(a){a.preventDefault();a.stopPropagation()})})})},checkEmptyDrag:function(a){$(a).outerHeight()||this.trigger("emptyDrag",[a],this)},initDrops:function(a){var b=this;$.each(a,function(c){b.checkEmptyDropPanel(this);b.trigger("initDrops",[this,a],b)})},inject:function(a,b){this.addWidget(this.curEl,a,b||this.theme)},ghostDrop:function(a,b){a="string"===$.type(a)?$.parseJSON(a):a;this.drag_operate_box.css("visibility","hidden").data("lock",
!0);$("#tempDropBox").remove();this.tempDropBox=$('<div id="tempDropBox"></div>').appendTo(document.body);try{var c=this.drag_operate_box.data("drag");this.tempDropBox.empty();this.addWidget(c,a,b);this.drag_operate_box.data("lock",!1)}catch(d){alert(JSON.stringify(d))}var e=this;$(document.body).on("contextmenu",function(a){a.preventDefault();$("#tempDropBox").remove();e.drag_operate_box.data("lock",!1);$(this).off("contextmenu",arguments.callee)})},addWidget:function(a,b,c){this.curdialog=new top.Dialog(top.SHOPADMINDIR+
"?app=site&ctl=admin_theme_widget&act=do_add_widgets&widgets="+b.name+"&widgets_app="+b.app+"&widgets_theme="+b.theme+"&theme="+c,{modal:!0,title:"添加挂件 "+(b.label||""),ajaxoptions:{render:!1},width:0.7,height:0.7});this.curDrop=a},editWidget:function(a){var b={modal:!0,title:"编辑挂件 "+(a.label||a.attr("title")||""),ajaksable:!1,width:0.7,height:0.7};this.curWidget=$(a);return a.attr("ishtml")?this.curdialog=new top.Dialog(top.SHOPADMINDIR+"?ctl=content/pages&act=editHtml",$.extend(b,{ajaksable:!0,ajaxoptions:{method:"post",
data:"htmls="+encodeURIComponent(a.find(".content-html").html().clean().trim())},title:"编辑HTML"})):this.curdialog=new top.Dialog(top.SHOPADMINDIR+"?app=site&ctl=admin_theme_widget&act=do_edit_widgets&widgets_id="+a.attr("widgets_id")+"&theme="+a.attr("widgets_theme"),b)},delWidget:function(a){var b=this.drag_operate_box,c=this;b.css("visibility","hidden").data("lock",!0);var d=a.parent();a.animate({opacity:0},{duration:250,complete:function(){a.remove();b.data("lock",!1);c.checkEmptyDropPanel(d[0]);
try{top.document.getElementById("btn_save").disabled=!1}catch(e){}}})},preview:function(a,b){var c=[],d={};this.drops.each(function(a,b){var g=$(b).find(".shopWidgets_box"),m=$(b).attr("base_file"),k=$(b).attr("base_slot"),l=$(b).attr("base_id");g.each(function(a,b){c.push(substitute("widgets[{widgetsId}]={baseFile}:{baseSlot}:{baseId}",{widgetsId:$(b).attr("widgets_id"),baseFile:m,baseSlot:k,baseId:l}));if($(b).attr("ishtml")){var d=$(b).find(".content-html");c.push(substitute("html[{widgetsId}]={htmls}",
{widgetsId:$(b).attr("widgets_id"),htmls:encodeURIComponent(d.html())}))}});d[$(b).attr("base_file")]=1});for(f in d)c.push("files[]="+f);$.ajax(a,{type:"post",data:c.join("&"),beforeSend:function(){$(b).prop("disabled",!0).html("<span><span>正在生成预览...</span></span>")},success:function(a){a=$.parseJSON(a);$(b).prop("disabled",!1).html("<span><span>预览模板</span></span>");if(a&&a.success)if(a=document.getElementById("_temp_preview_link")||$('<a href="'+(a.url||top.PREVIEW_URL)+'" id="_temp_preview_link" class="hide" target="preview"></a>').appendTo(document.body)[0],
document.createEvent){var c=document.createEvent("MouseEvent");c.initEvent("click",!1,!1);a.dispatchEvent(c)}else a.click()}})},saveAll:function(a,b){var c=[],d={},e=this;this.drops.each(function(a,b){var e=$(b).find(".shopWidgets_box"),k=$(b).attr("base_file"),l=$(b).attr("base_slot"),n=$(b).attr("base_id");e.each(function(a,b){c.push(substitute("widgets[{widgetsId}]={baseFile}:{baseSlot}:{baseId}",{widgetsId:$(b).attr("widgets_id"),baseFile:k,baseSlot:l,baseId:n}));if($(b).attr("ishtml")){var d=
$(b).find(".content-html");c.push(substitute("html[{widgetsId}]={htmls}",{widgetsId:$(b).attr("widgets_id"),htmls:encodeURIComponent(d.html())}))}});d[$(b).attr("base_file")]=1});for(f in d)c.push("files[]="+f);$.ajax(top.SHOPADMINDIR+"?app=site&ctl=admin_theme_widget&act=save_all",{type:"post",data:c.join("&"),beforeSend:function(){top.MessageBox.show("正在保存")},success:function(c){a&&a.call(b||e,e);try{c=$.parseJSON(c);for(dom in c)$(dom)&&c[dom]&&$(dom).attr("widgets_id",c[dom]);top.MessageBox.success("保存成功。")}catch(d){top.MessageBox.error("​保存失败："+
d.message)}}})}});
$(function(){window.shopWidgets=new Widgets(".shopWidgets_box",".shopWidgets_panel",{init:function(){this.theme=top.THEME_NAME||""},edit:function(a,b){this.editWidget(a)},"delete":function(a){var b=this;top.confirmDialog?top.confirmDialog("确定删除此挂件吗？",function(){b.delWidget(a)}):confirm("确定删除此挂件吗？")&&this.delWidget(a)},add:function(a,b){var c=this.drag_operate_box,d=b?b.attr("class")||"":"",e=this;c.data("lock",!0);this.widgetsDialog=new top.Dialog(top.SHOPADMINDIR+"?app=site&ctl=admin_theme_widget&act=add_widgets_page&theme="+this.theme,
{width:770,height:500,title:"添加挂件",modal:!0,resizeable:!1,onShow:function(b){this.dialog_body.id="dialogContent";a.hasClass("empty_drop_box")?e.injectBox=a.parent():(e.injectWhere=d,e.injectBox=null)},onClose:function(){c.data("lock",!1)}})},upDown:function(a,b){top.document.id("btn_save")&&(top.document.id("btn_save").disabled=!1)},emptyDrag:function(a){$('<div class="empty_drag_box">(TEMP DATA)</div>').appendTo(a)}})});